<!DOCTYPE html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <title>Gracz – Panel</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
    <link
      rel="icon"
      type="image/x-icon"
      href="{{ url_for('static', filename='favicon.ico') }}"
    />
    <script
      src="https://unpkg.com/html5-qrcode"
      type="text/javascript"
    ></script>
    <link
      rel="icon"
      type="image/x-icon"
      href="{{ url_for('static', filename='favicon.ico') }}"
    />
    <style></style>
  </head>
  <body>
    <div class="dashboard-container">
      <h1 class="dashboard-title">Witaj, {{ username }}!</h1>
      <p class="dashboard-subtitle">
        Jesteś zalogowany jako <strong>gracz</strong>.
      </p>

      <div id="reader" class="qr-scanner"></div>

      <button onclick="window.location.href='/logout'" class="logout-button">
        Wyloguj
      </button>
    </div>

    <script>
      let locationWatchId = null;

      // Wysyłanie lokalizacji
      function sendLocation(lat, lon) {
        fetch("/update_location", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ latitude: lat, longitude: lon }),
        })
          .then((res) => res.json())
          .then((data) => {
            console.log("Location sent:", data);
          })
          .catch((err) => {
            console.error("Location error:", err);
          });
      }

      // Obsługa pozycji z GPS
      function handlePosition(position) {
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;
        sendLocation(lat, lon);
      }

      // Obsługa błędów GPS (bez wyświetlania użytkownikowi)
      function handleLocationError(error) {
        console.error("Geolocation error:", error);
        // Logujemy błędy tylko do konsoli, nie pokazujemy użytkownikowi
      }

      // Inicjalizacja lokalizacji
      function initializeLocation() {
        if (!navigator.geolocation) {
          console.error("Geolocation not supported");
          return;
        }

        // Opcje geolokalizacji
        const options = {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 30000,
        };

        // Rozpocznij śledzenie lokalizacji
        locationWatchId = navigator.geolocation.watchPosition(
          handlePosition,
          handleLocationError,
          options
        );
      }

      // QR Skaner
      function onScanSuccess(decodedText) {
        // Zatrzymaj skaner
        if (window.qrScanner) {
          window.qrScanner.stop();
        }

        // Przekieruj do zadania
        window.location.href = `/zadanie/${encodeURIComponent(decodedText)}`;
      }

      function onScanError(error) {
        // Błędy skanowania ignorujemy (są bardzo częste)
      }

      // Inicjalizacja aplikacji
      window.onload = () => {
        // Inicjalizuj lokalizację (w tle, bez powiadomień dla użytkownika)
        initializeLocation();

        // Inicjalizuj skaner QR
        try {
          const qr = new Html5Qrcode("reader");
          window.qrScanner = qr; // Zapisz referencję do późniejszego użycia

          qr.start(
            { facingMode: "environment" },
            {
              fps: 10,
              qrbox: { width: 250, height: 250 },
              aspectRatio: 1.0,
            },
            onScanSuccess,
            onScanError
          ).catch((err) => {
            console.error("QR Scanner error:", err);
            document.getElementById("reader").innerHTML =
              '<div style="color: #ff6b6b; padding: 20px; text-align: center;">❌ Nie udało się uruchomić skanera QR.<br>Sprawdź dostęp do kamery.</div>';
          });
        } catch (err) {
          console.error("QR Scanner initialization error:", err);
        }
      };

      // Czyszczenie przy opuszczeniu strony
      window.onbeforeunload = () => {
        if (locationWatchId) {
          navigator.geolocation.clearWatch(locationWatchId);
        }
        if (window.qrScanner) {
          window.qrScanner.stop();
        }
      };
    </script>
  </body>
</html>
