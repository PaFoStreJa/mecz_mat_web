<!DOCTYPE html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <title>Zadanie</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
    <link
      rel="icon"
      type="image/x-icon"
      href="{{ url_for('static', filename='favicon.ico') }}"
    />
    <style>
      .zadanie-container {
        background: rgba(40, 40, 55, 0.9);
        backdrop-filter: blur(8px);
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.6);
        width: 90%;
        max-width: 700px;
        text-align: center;
        margin: 2rem auto;
        color: #f0f0f0;
      }
      .zadanie-container h1 {
        font-size: 2rem;
        margin-bottom: 1rem;
        color: #ffffff;
      }
      .zadanie-container p {
        font-size: 1.1rem;
        margin-bottom: 1rem;
        color: #cccccc;
      }
      .zadanie-container pre {
        background-color: #1e1e2f;
        padding: 1rem;
        border-radius: 1rem;
        font-size: 1.1rem;
        white-space: pre-wrap;
        word-break: break-word;
        box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.4);
        margin-bottom: 2rem;
      }
      .zadanie-container button {
        padding: 12px 24px;
        font-size: 1rem;
        border: none;
        border-radius: 12px;
        background-color: #4f78ff;
        color: white;
        cursor: pointer;
        transition: background-color 0.3s;
      }
      .zadanie-container button:hover {
        background-color: #345ee0;
      }
      .czas-trwania {
        font-size: 1.2rem;
        font-weight: bold;
        color: #00c853;
        margin-bottom: 1rem;
      }
    </style>
  </head>
  <body>
    <div class="zadanie-container">
      <h1>Zadanie</h1>
      <div class="czas-trwania">Czas trwania: <span id="czas">00:00</span></div>
      <pre>{{ tresc }}</pre>

      <form id="end-form">
        <button type="button" id="start-camera-btn">
          Zakończ zadanie i zrób zdjęcie
        </button>
      </form>

      <div id="camera-container" style="display: none; margin-top: 20px">
        <video id="camera" width="320" height="240" autoplay></video>
        <br />
        <button id="take-photo-btn">Zrób zdjęcie</button>
        <canvas
          id="canvas"
          width="320"
          height="240"
          style="display: none"
        ></canvas>
      </div>
    </div>

    <script>
          const startBtn = document.getElementById("start-camera-btn");
          const cameraContainer = document.getElementById("camera-container");
          const video = document.getElementById("camera");
          const takePhotoBtn = document.getElementById("take-photo-btn");
          const canvas = document.getElementById("canvas");
          const ctx = canvas.getContext("2d");

          let stream;

          startBtn.addEventListener("click", async () => {
            startBtn.disabled = true;
            cameraContainer.style.display = "block";

            try {
              stream = await navigator.mediaDevices.getUserMedia({ video: true });
              video.srcObject = stream;
            } catch (err) {
              alert("Nie udało się uzyskać dostępu do kamery: " + err.message);
              startBtn.disabled = false;
            }
          });

          takePhotoBtn.addEventListener("click", async () => {
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            stream.getTracks().forEach((track) => track.stop());
            cameraContainer.style.display = "none";

            canvas.toBlob(async (blob) => {
              if (!blob) {
                alert("Błąd podczas tworzenia zdjęcia");
                startBtn.disabled = false;
                return;
              }

              const formData = new FormData();
              formData.append("file", blob, "{{ username }}_{{ task_id }}.jpg");

              try {
                const response = await fetch(`/upload_solution/{{ task_id }}`, {
                  method: "POST",
                  body: formData,
                });

                const data = await response.json();

                if (response.ok && data.status === "success") {
                  // Po wysłaniu zdjęcia wywołaj zakończenie zadania
                  const endResponse = await fetch(
                    `/zakoncz_zadanie/{{ task_id }}`,
                    { method: "POST" }
                  );
                  const endData = await endResponse.json();

                  if (endResponse.ok && endData.status === "zakończono") {
                    alert("Zdjęcie wysłane, zadanie zakończone!");
                    window.location.href = "/player";
                  } else {
                    alert("Błąd przy kończeniu zadania.");
                    startBtn.disabled = false;
                  }
                } else {
                  alert("Błąd: " + (data.error || "Nie udało się wysłać zdjęcia"));
                  startBtn.disabled = false;
                }
              } catch (err) {
                alert("Wystąpił błąd: " + err.message);
                startBtn.disabled = false;
              }
            }, "image/jpeg");
          });

          // Poprawiony licznik czasu:
          const startTime = new Date("{{ start_time_iso }}");
      const endTime = {{ 'new Date("' + end_time_iso + '")' if end_time_iso else 'null' }};

      function updateTimer() {
        const now = new Date();
        let diffMs;

        if (endTime) {
          diffMs = endTime - startTime;
        } else {
          diffMs = now - startTime;
        }

        const totalSeconds = Math.floor(diffMs / 1000);
        const minutes = String(Math.floor(totalSeconds / 60)).padStart(2, "0");
        const seconds = String(totalSeconds % 60).padStart(2, "0");

        document.getElementById("czas").textContent = `${minutes}:${seconds}`;
      }

      setInterval(updateTimer, 1000);
      updateTimer();
    </script>
  </body>
</html>
