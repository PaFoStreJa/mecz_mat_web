<!DOCTYPE html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <title>Panel Admina</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <link
      rel="icon"
      type="image/x-icon"
      href="{{ url_for('static', filename='favicon.ico') }}"
    />
    <style>
      .fullscreen-img {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.85);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        cursor: pointer;
      }

      .fullscreen-img img {
        max-width: 90vw;
        max-height: 90vh;
        border-radius: 10px;
      }

      .fullscreen-img.hidden {
        display: none;
      }

      .gallery-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 10px;
        margin-top: 20px;
      }

      .gallery-item {
        text-align: center;
        background-color: #2b2b3d;
        border-radius: 10px;
        padding: 10px;
      }

      .gallery-item img {
        width: 100%;
        height: 150px;
        object-fit: cover;
        cursor: pointer;
        border-radius: 8px;
        transition: transform 0.2s;
      }

      .gallery-item img:hover {
        transform: scale(1.05);
      }

      .gallery-item p {
        font-size: 0.8em;
        margin-top: 8px;
        color: #cccccc;
        word-break: break-all;
      }

      .gallery-item .username {
        font-weight: bold;
        color: #4f78ff;
        margin-bottom: 5px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        background-color: #2b2b3d;
        border-radius: 10px;
        overflow: hidden;
      }

      th,
      td {
        border: 1px solid #444;
        padding: 8px;
        text-align: center;
        font-size: 0.9em;
      }

      th {
        background-color: #4f78ff;
        color: white;
        font-weight: bold;
      }

      tr:nth-child(even) {
        background-color: #3a3a55;
      }

      .error-message {
        color: #ff6b6b;
        padding: 10px;
        background-color: #ff6b6b20;
        border-radius: 8px;
        margin: 10px 0;
      }

      .loading {
        color: #4f78ff;
        font-style: italic;
      }

      .success-message {
        color: #00c853;
        padding: 10px;
        background-color: #00c85320;
        border-radius: 8px;
        margin: 10px 0;
      }

      .warning-message {
        color: #ffa726;
        padding: 10px;
        background-color: #ffa72620;
        border-radius: 8px;
        margin: 10px 0;
      }

      .refresh-btn {
        background-color: #28a745;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 5px;
        cursor: pointer;
        margin: 10px 5px 10px 0;
        transition: background-color 0.3s;
      }

      .refresh-btn:hover {
        background-color: #218838;
      }

      .refresh-btn:disabled {
        background-color: #666;
        cursor: not-allowed;
      }

      .map-stats {
        display: flex;
        justify-content: space-around;
        margin: 10px 0;
        font-size: 0.9em;
      }

      .map-stat {
        text-align: center;
        padding: 5px;
      }

      .marker-active {
        color: #00c853;
      }

      .marker-inactive {
        color: #ff6b6b;
      }

      .marker-old {
        color: #ffa726;
      }
    </style>
  </head>
  <body>
    <div class="dashboard-container">
      <h1 class="dashboard-title">Witaj, {{ username }} (Admin)</h1>

      <div class="dashboard-grid">
        <div class="tile" onclick="showPanel('map-panel')">
          <h2>üó∫Ô∏è Mapa graczy</h2>
        </div>
        <div class="tile" onclick="showPanel('times-panel')">
          <h2>‚è±Ô∏è Czas wykonania zada≈Ñ</h2>
        </div>
        <div class="tile" onclick="showPanel('gallery-panel')">
          <h2>üì∑ Galeria zdjƒôƒá</h2>
        </div>
      </div>

      <div class="content-panel">
        <div id="map-panel" class="">
          <button
            class="refresh-btn"
            onclick="fetchLocations()"
            id="refresh-locations-btn"
          >
            üîÑ Od≈õwie≈º lokalizacje
          </button>
          <div class="map-stats">
            <div class="map-stat">
              <div class="marker-active">‚óè Aktywny (< 5 min)</div>
            </div>
            <div class="map-stat">
              <div class="marker-old">‚óè Nieaktualny (5-30 min)</div>
            </div>
            <div class="map-stat">
              <div class="marker-inactive">‚óè Nieaktywny (> 30 min)</div>
            </div>
          </div>
          <div id="map" style="height: 400px"></div>
          <div id="map-status" class="loading">≈Åadowanie mapy...</div>
        </div>

        <div id="times-panel" class="hidden">
          <button
            class="refresh-btn"
            onclick="fetchTimes()"
            id="refresh-times-btn"
          >
            üîÑ Od≈õwie≈º czasy
          </button>
          <div id="times-status" class="loading">≈Åadowanie czas√≥w...</div>
          <table id="times-table">
            <thead>
              <tr>
                <th>Gracz</th>
                <th>Zadanie</th>
                <th>Start</th>
                <th>Koniec</th>
                <th>Czas trwania</th>
                <th>Plik</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div id="gallery-panel" class="hidden">
          <button
            class="refresh-btn"
            onclick="fetchGallery()"
            id="refresh-gallery-btn"
          >
            üîÑ Od≈õwie≈º galeriƒô
          </button>
          <button
            class="refresh-btn"
            onclick="debugFiles()"
            style="background-color: #ffa726"
            id="debug-files-btn"
          >
            üîç Debug plik√≥w
          </button>
          <div id="gallery-status" class="loading">≈Åadowanie galerii...</div>
          <div
            id="debug-info"
            style="
              display: none;
              background: #2b2b3d;
              padding: 10px;
              border-radius: 5px;
              margin: 10px 0;
              font-family: monospace;
              font-size: 12px;
            "
          ></div>
          <div class="gallery-grid" id="gallery-container"></div>
        </div>
      </div>

      <button class="logout-button" onclick="window.location.href='/logout'">
        Wyloguj
      </button>
    </div>

    <div
      class="fullscreen-img hidden"
      id="fullscreen-img"
      onclick="this.classList.add('hidden')"
    >
      <img src="" alt="Powiƒôkszone zdjƒôcie" />
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
      function showPanel(id) {
        ["map-panel", "times-panel", "gallery-panel"].forEach((p) =>
          document.getElementById(p).classList.add("hidden")
        );
        document.getElementById(id).classList.remove("hidden");

        // Od≈õwie≈º dane po prze≈ÇƒÖczeniu panelu
        if (id === "map-panel") {
          setTimeout(() => {
            if (map) map.invalidateSize();
          }, 100);
        }
      }

      function showError(elementId, message) {
        const element = document.getElementById(elementId);
        element.innerHTML = `<div class="error-message">‚ùå ${message}</div>`;
      }

      function showSuccess(elementId, message) {
        const element = document.getElementById(elementId);
        element.innerHTML = `<div class="success-message">‚úÖ ${message}</div>`;
      }

      function showWarning(elementId, message) {
        const element = document.getElementById(elementId);
        element.innerHTML = `<div class="warning-message">‚ö†Ô∏è ${message}</div>`;
      }

      function showLoading(elementId, message = "≈Åadowanie...") {
        const element = document.getElementById(elementId);
        element.innerHTML = `<div class="loading">${message}</div>`;
      }

      function disableButton(buttonId, text = "≈Åadowanie...") {
        const btn = document.getElementById(buttonId);
        if (btn) {
          btn.disabled = true;
          btn.textContent = text;
        }
      }

      function enableButton(buttonId, text) {
        const btn = document.getElementById(buttonId);
        if (btn) {
          btn.disabled = false;
          btn.textContent = text;
        }
      }

      // MAPA
      const map = L.map("map").setView([50.0647, 19.945], 12); // Krak√≥w jako domy≈õlna lokalizacja
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 18,
        attribution: "¬© OpenStreetMap contributors",
      }).addTo(map);
      let markers = {};

      function getMarkerColor(minutesAgo) {
        if (minutesAgo < 5) return "green";
        if (minutesAgo < 30) return "orange";
        return "red";
      }

      function createColoredMarker(color) {
        return L.divIcon({
          html: `<div style="background-color: ${color}; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.5);"></div>`,
          iconSize: [20, 20],
          iconAnchor: [10, 10],
        });
      }

      async function fetchLocations() {
        disableButton("refresh-locations-btn", "üîÑ Od≈õwie≈ºanie...");
        showLoading("map-status", "Pobieranie lokalizacji...");

        try {
          const res = await fetch("/get_locations");
          if (!res.ok) {
            throw new Error(`HTTP ${res.status}: ${res.statusText}`);
          }
          const data = await res.json();

          if (data.error) {
            throw new Error(data.error);
          }

          // Usu≈Ñ nieistniejƒÖcych u≈ºytkownik√≥w
          for (const user in markers) {
            if (!data[user]) {
              map.removeLayer(markers[user]);
              delete markers[user];
            }
          }

          // Dodaj/zaktualizuj markery
          let activeUsers = 0;
          let inactiveUsers = 0;
          let oldUsers = 0;

          if (Object.keys(data).length === 0) {
            showWarning(
              "map-status",
              "Brak danych o lokalizacji graczy. Sprawd≈∫ czy gracze majƒÖ w≈ÇƒÖczonƒÖ lokalizacjƒô."
            );
            enableButton("refresh-locations-btn", "üîÑ Od≈õwie≈º lokalizacje");
            return;
          }

          for (const [username, loc] of Object.entries(data)) {
            const latlng = [loc.latitude, loc.longitude];
            const lastUpdate = new Date(loc.last_update);
            const timeAgo = Math.round((new Date() - lastUpdate) / 1000 / 60);
            const color = getMarkerColor(timeAgo);

            // Klasyfikuj u≈ºytkownik√≥w
            if (timeAgo < 5) activeUsers++;
            else if (timeAgo < 30) oldUsers++;
            else inactiveUsers++;

            const popupContent = `
              <b>${username}</b><br>
              Ostatnia aktualizacja: ${timeAgo} min temu<br>
              Status: ${
                timeAgo < 5
                  ? "üü¢ Aktywny"
                  : timeAgo < 30
                  ? "üü° Nieaktualny"
                  : "üî¥ Nieaktywny"
              }<br>
              Czas: ${lastUpdate.toLocaleString("pl-PL")}
            `;

            if (markers[username]) {
              markers[username].setLatLng(latlng);
              markers[username].setPopupContent(popupContent);
              markers[username].setIcon(createColoredMarker(color));
            } else {
              markers[username] = L.marker(latlng, {
                icon: createColoredMarker(color),
              })
                .addTo(map)
                .bindPopup(popupContent);
            }
          }

          const totalUsers = activeUsers + oldUsers + inactiveUsers;
          let statusMessage = `Gracze: ${totalUsers} (üü¢ ${activeUsers} aktywnych`;
          if (oldUsers > 0) statusMessage += `, üü° ${oldUsers} nieaktualnych`;
          if (inactiveUsers > 0)
            statusMessage += `, üî¥ ${inactiveUsers} nieaktywnych`;
          statusMessage += ")";

          if (activeUsers === 0 && totalUsers > 0) {
            showWarning(
              "map-status",
              statusMessage +
                "<br><small>Brak aktywnych lokalizacji. Gracze mogƒÖ mieƒá wy≈ÇƒÖczonƒÖ geolokalizacjƒô.</small>"
            );
          } else {
            showSuccess("map-status", statusMessage);
          }
        } catch (error) {
          console.error("B≈ÇƒÖd pobierania lokalizacji:", error);
          showError(
            "map-status",
            `Nie uda≈Ço siƒô pobraƒá lokalizacji: ${error.message}`
          );
        } finally {
          enableButton("refresh-locations-btn", "üîÑ Od≈õwie≈º lokalizacje");
        }
      }

      // TABELA CZAS√ìW
      async function fetchTimes() {
        disableButton("refresh-times-btn", "üîÑ Od≈õwie≈ºanie...");
        showLoading("times-status", "Pobieranie czas√≥w wykonania...");

        try {
          const res = await fetch("/get_task_times");
          if (!res.ok) {
            throw new Error(`HTTP ${res.status}: ${res.statusText}`);
          }
          const data = await res.json();

          if (data.error) {
            throw new Error(data.error);
          }

          const tbody = document.querySelector("#times-table tbody");
          tbody.innerHTML = "";

          if (data.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="6" style="color: #cccccc; font-style: italic;">Brak danych o czasach wykonania zada≈Ñ</td></tr>';
            showWarning(
              "times-status",
              "Brak danych o czasach wykonania zada≈Ñ"
            );
            return;
          }

          data.forEach((row) => {
            const tr = document.createElement("tr");
            const startDate = row.start
              ? new Date(row.start).toLocaleString("pl-PL")
              : "-";
            const endDate = row.end
              ? new Date(row.end).toLocaleString("pl-PL")
              : "-";
            const filename = row.filename || "-";

            tr.innerHTML = `
              <td>${row.username}</td>
              <td title="${row.task_id}">${row.task_id.substring(0, 8)}...</td>
              <td>${startDate}</td>
              <td>${endDate}</td>
              <td>${row.duration || "-"}</td>
              <td title="${filename}">${
              filename.length > 20
                ? filename.substring(0, 20) + "..."
                : filename
            }</td>
            `;
            tbody.appendChild(tr);
          });

          showSuccess("times-status", `Za≈Çadowano ${data.length} rekord√≥w`);
        } catch (error) {
          console.error("B≈ÇƒÖd pobierania czas√≥w:", error);
          showError(
            "times-status",
            `Nie uda≈Ço siƒô pobraƒá czas√≥w: ${error.message}`
          );
        } finally {
          enableButton("refresh-times-btn", "üîÑ Od≈õwie≈º czasy");
        }
      }

      // GALERIA
      async function fetchGallery() {
        disableButton("refresh-gallery-btn", "üîÑ Od≈õwie≈ºanie...");
        showLoading("gallery-status", "Pobieranie galerii...");

        try {
          const res = await fetch("/get_gallery");
          if (!res.ok) {
            throw new Error(`HTTP ${res.status}: ${res.statusText}`);
          }
          const data = await res.json();

          if (data.error) {
            throw new Error(data.error);
          }

          const container = document.getElementById("gallery-container");
          container.innerHTML = "";

          if (data.length === 0) {
            container.innerHTML =
              '<div style="color: #cccccc; text-align: center; padding: 20px;">Brak zdjƒôƒá w galerii</div>';
            showWarning("gallery-status", "Galeria jest pusta");
            return;
          }

          data.forEach((item) => {
            const div = document.createElement("div");
            div.className = "gallery-item";

            const img = document.createElement("img");

            // Testuj r√≥≈ºne URL-e w kolejno≈õci preferencji
            const urlsToTry = [
              item.image_url, // Custom endpoint
              item.static_url, // Flask static
              item.direct_path, // Direct static path
              `/uploads/solutions/${item.username}/${item.filename}`, // Fallback
            ].filter((url) => url); // Usu≈Ñ puste URL-e

            let urlIndex = 0;

            function tryNextUrl() {
              if (urlIndex < urlsToTry.length) {
                img.src = urlsToTry[urlIndex];
                console.log(
                  `Pr√≥bujƒô URL ${urlIndex + 1}/${urlsToTry.length}: ${img.src}`
                );
                urlIndex++;
              } else {
                console.error("Wszystkie URL-e nie dzia≈ÇajƒÖ:", urlsToTry);
                img.src =
                  "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjE1MCIgdmlld0JveD0iMCAwIDE1MCAxNTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxNTAiIGhlaWdodD0iMTUwIiBmaWxsPSIjMzMzIi8+Cjx0ZXh0IHg9Ijc1IiB5PSI3NSIgZmlsbD0iIzY2NiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSI+QnJhayBvYnJhenU8L3RleHQ+Cjwvc3ZnPg==";
              }
            }

            img.alt = `RozwiƒÖzanie ${item.username}`;
            img.onerror = function () {
              console.error("B≈ÇƒÖd ≈Çadowania obrazu:", this.src);
              tryNextUrl();
            };
            img.onload = function () {
              console.log("Obraz za≈Çadowany pomy≈õlnie:", this.src);
            };

            // Rozpocznij ≈Çadowanie
            tryNextUrl();

            img.onclick = () => {
              document
                .getElementById("fullscreen-img")
                .classList.remove("hidden");
              document.querySelector("#fullscreen-img img").src = img.src;
            };

            const userDiv = document.createElement("div");
            userDiv.className = "username";
            userDiv.textContent = item.username;

            const fileDiv = document.createElement("p");
            fileDiv.innerHTML = `${item.filename}<br>
              <small style="color: #888;">
                Rozmiar: ${item.file_size || 0} B<br>
                Istnieje: ${item.file_exists ? "‚úÖ" : "‚ùå"}
              </small>`;

            div.appendChild(img);
            div.appendChild(userDiv);
            div.appendChild(fileDiv);
            container.appendChild(div);
          });

          showSuccess("gallery-status", `Za≈Çadowano ${data.length} zdjƒôƒá`);
        } catch (error) {
          console.error("B≈ÇƒÖd pobierania galerii:", error);
          showError(
            "gallery-status",
            `Nie uda≈Ço siƒô pobraƒá galerii: ${error.message}`
          );
        } finally {
          enableButton("refresh-gallery-btn", "üîÑ Od≈õwie≈º galeriƒô");
        }
      }

      // DEBUG FUNKCJA
      async function debugFiles() {
        disableButton("debug-files-btn", "üîç Debugowanie...");
        try {
          const res = await fetch("/debug_files");
          const data = await res.json();

          const debugDiv = document.getElementById("debug-info");
          debugDiv.style.display = "block";
          debugDiv.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
        } catch (error) {
          console.error("B≈ÇƒÖd debugowania:", error);
          const debugDiv = document.getElementById("debug-info");
          debugDiv.style.display = "block";
          debugDiv.innerHTML = `<div class="error-message">B≈ÇƒÖd debugowania: ${error.message}</div>`;
        } finally {
          enableButton("debug-files-btn", "üîç Debug plik√≥w");
        }
      }

      // Inicjalizacja
      document.addEventListener("DOMContentLoaded", function () {
        fetchLocations();
        fetchTimes();
        fetchGallery();

        // Auto-refresh co 30 sekund
        setInterval(() => {
          if (
            !document.getElementById("map-panel").classList.contains("hidden")
          ) {
            fetchLocations();
          }
          if (
            !document.getElementById("times-panel").classList.contains("hidden")
          ) {
            fetchTimes();
          }
        }, 30000);
      });

      // Obs≈Çuga klawiszy
      document.addEventListener("keydown", function (e) {
        if (e.key === "Escape") {
          document.getElementById("fullscreen-img").classList.add("hidden");
        }
      });
    </script>
  </body>
</html>
